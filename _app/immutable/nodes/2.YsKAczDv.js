var ee=Object.defineProperty;var te=(r,t,e)=>t in r?ee(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var m=(r,t,e)=>(te(r,typeof t!="symbol"?t+"":t,e),e);import{s as se,x as re,i as ae,n as z,r as ie,o as ne,y as oe,e as le}from"../chunks/scheduler.B8wtCbz7.js";import{S as ce,i as he,e as E,s as L,t as X,c as Y,a as N,d as k,f as P,y as ue,b as D,o as R,g as S,h as g,z as F,j as A}from"../chunks/index.Dt0ReVwJ.js";class me{constructor(t,e){m(this,"world");m(this,"canvas");m(this,"ctx");m(this,"cameraX",0);m(this,"cameraY",0);m(this,"cameraZoom",32);m(this,"cameraMinZoom",4);m(this,"cameraMaxZoom",64);this.world=t,this.canvas=e;const s=this.canvas.getContext("2d");if(!s)throw new Error("This browser or machine does not support canvas 2d.");this.ctx=s}cameraWidth(){return this.canvas.width/this.cameraZoom}cameraHeight(){return this.canvas.height/this.cameraZoom}cameraTranslate(t,e){this.cameraX-=t/this.cameraZoom,this.cameraY-=e/this.cameraZoom}cameraScale(t){const e=this.cameraX+this.cameraWidth()*.5,s=this.cameraY+this.cameraHeight()*.5;this.cameraZoom*=t,this.canvas.width/this.cameraZoom<this.cameraMinZoom&&(this.cameraZoom=this.canvas.width/this.cameraMinZoom),this.canvas.height/this.cameraZoom<this.cameraMinZoom&&(this.cameraZoom=this.canvas.height/this.cameraMinZoom),this.canvas.width/this.cameraZoom>this.cameraMaxZoom&&(this.cameraZoom=this.canvas.width/this.cameraMaxZoom),this.canvas.height/this.cameraZoom>this.cameraMaxZoom&&(this.cameraZoom=this.canvas.height/this.cameraMaxZoom);const a=this.cameraX+this.cameraWidth()*.5,i=this.cameraY+this.cameraHeight()*.5;return this.cameraX-=a-e,this.cameraY-=i-s,this.cameraZoom}cameraBounds(t=0){return{minX:Math.floor(this.cameraX-t),minY:Math.floor(this.cameraY-t),maxX:Math.ceil(this.cameraX+this.cameraWidth()+t),maxY:Math.ceil(this.cameraY+this.cameraHeight()+t)}}cameraPos(t,e){return{x:Math.floor(t/this.cameraZoom+this.cameraX),y:Math.floor(e/this.cameraZoom+this.cameraY)}}renderWorld(){this.ctx.imageSmoothingEnabled=!1,this.ctx.scale(this.cameraZoom,this.cameraZoom),this.ctx.translate(-this.cameraX,-this.cameraY);const t=this.cameraBounds(1);for(let e=t.minX;e<t.maxX;e++)for(let s=t.minY;s<t.maxY;s++)this.ctx.save(),this.ctx.translate(e,s),this.ctx.scale(1.01,1.01),this.world.getTile(e,s).render(this.ctx),this.ctx.restore();this.ctx.imageSmoothingEnabled=!0}render(){this.ctx.reset(),this.ctx.fillStyle="purple",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderWorld()}}const y=32;class Q{constructor(t,e,s){m(this,"world");m(this,"chunkX");m(this,"chunkY");this.world=t,this.chunkX=e,this.chunkY=s}isGenerated(){return this instanceof U}generate(){if(this.isGenerated())throw new Error("Cannot generate an already generated chunk.");console.log(`Generating new chunk: ${this.chunkX}, ${this.chunkY}`);const t=[];for(let e=0;e<y;e++)for(let s=0;s<y;s++){const a=this.world.generateTile(this.chunkX*y+s,this.chunkY*y+e);t.push(a)}return new U(this.world,this.chunkX,this.chunkY,t)}}class U extends Q{constructor(e,s,a,i){super(e,s,a);m(this,"tiles");if(this.tiles=i,this.tiles.length!=y*y)throw new Error("GeneratedChunk incorrect tiles length.")}getTileAbsolute(e,s){return this.getTile(e-this.chunkX*y,s-this.chunkY*y)}getTile(e,s){return this.tiles[e+s*y]}}function B(r,t){return()=>{r|=0,r=r+2654435769|0;let e=r^r>>>16;e=Math.imul(e,569420461),e=e^e>>>15,e=Math.imul(e,1935289751);const s=(e=e^e>>>15)>>>0;return t?s/4294967296:s}}function W(r,t,e,s){return r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=t,r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=e,r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=s,r^=r<<16|r>>>15,r=r*2158630691+3333583613&4294967295,(r>>>0)/4294967295}function fe(r,t){t*=r.reduce((e,s)=>e+s,0);for(let e=0;e<r.length;e++)if(t-=r[e],t<=0)return e;throw new Error("Invalid weights")}function de(r,t,e,s){let a=[];for(let o=Math.floor(t)-1;o<Math.ceil(t)+1;o++)for(let c=Math.floor(e)-1;c<Math.ceil(e)+1;c++)a.push({x:o+W(r,o,c,0)-.5,y:c+W(r,o,c,1)-.5,type:fe(s,W(r,o,c,2))});let i=1/0,l=-1;for(const o of a){const c=Math.sqrt((o.x-t)**2+(o.y-e)**2);c<i&&(i=c,l=o.type)}if(l==-1)throw new Error("Voronoi noise error.");return l}function K(r,t,e){function s(_,M,b){return(M-_)*((b*(b*6-15)+10)*b*b*b)+_}const a=(_,M)=>{const b=W(r,_,M,0);return{x:Math.cos(b),y:Math.sin(b)}},i=(_,M,b,T)=>{const x=a(_,M),h=b-_,n=T-M;return h*x.x+n*x.y},l=Math.floor(t),o=l+1,c=Math.floor(e),f=c+1,w=t-l,p=e-c;return s(s(i(l,c,t,e),i(o,c,t,e),w),s(i(l,f,t,e),i(o,f,t,e),w),p)}class _e{constructor(t,e){m(this,"textures");m(this,"src");m(this,"img");this.src=t,this.img=document.createElement("img"),this.img.src=this.src,this.textures=e}awaitLoad(){return new Promise((t,e)=>{if(this.img.naturalWidth!==0)return t();const s=()=>{this.img.removeEventListener("load",s),this.img.removeEventListener("error",a),t()},a=()=>{this.img.removeEventListener("load",s),this.img.removeEventListener("error",a),e()};this.img.addEventListener("load",s),this.img.addEventListener("error",a)})}onLoad(t){this.awaitLoad().then(()=>t(this))}draw(t,e,s,a,i,l){const[o,c,f,w]=this.textures[e];t.drawImage(this.img,o,c,f,w,s,a,i,l)}}const d=new _e("/infinite-sweeper/tileset.png",{null:[0,0,16,16],bomb:[16,0,16,16],explosion:[16,16,16,16],flag:[32,16,16,16],number_0:[48,0,16,16],number_1:[48,16,16,16],number_2:[48,32,16,16],number_3:[48,48,16,16],number_4:[48,64,16,16],number_5:[48,80,16,16],number_6:[48,96,16,16],number_7:[48,112,16,16],number_8:[48,128,16,16],vanilla_tile_covered:[64,0,16,16],vanilla_tile_revealed:[80,0,16,16],chocolate_tile_covered:[64,16,16,16],chocolate_tile_revealed:[80,16,16,16],waffle_tile_covered_light:[64,32,16,16],waffle_tile_revealed_light:[80,32,16,16],waffle_tile_covered_dark:[96,32,16,16],waffle_tile_revealed_dark:[112,32,16,16],stroopwafel_tile_covered_light:[64,48,16,16],stroopwafel_tile_revealed_light:[80,48,16,16],stroopwafel_tile_covered_dark:[96,48,16,16],stroopwafel_tile_revealed_dark:[112,48,16,16]});function H(r){switch(r){case 0:return"number_0";case 1:return"number_1";case 2:return"number_2";case 3:return"number_3";case 4:return"number_4";case 5:return"number_5";case 6:return"number_6";case 7:return"number_7";case 8:return"number_8";default:return"null"}}class we{constructor(t,e,s){m(this,"world");m(this,"x");m(this,"y");this.world=t,this.x=e,this.y=s}minesNearby(){let t=0;for(const e of this.searchPattern)t+=this.world.getTile(this.x+e.x,this.y+e.y).numMines();return t}flagsNearby(){let t=0;for(const e of this.searchPattern)t+=this.world.getTile(this.x+e.x,this.y+e.y).numFlags();return t}}class V extends we{constructor(e,s,a,i){super(e,s,a);m(this,"isMine");m(this,"state",0);m(this,"searchPattern",[{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:-1}]);this.isMine=i}numMines(){return this.isMine?1:0}numFlags(){return this.state==1?1:0}flag(){this.state!=2&&(this.state==0?this.state=1:this.state=0)}reveal(){this.state!=1&&(this.state=2)}}class pe extends V{constructor(t,e,s){const a=W(t.tileSeed,e,s,0)>.875;super(t,e,s,a)}render(t){switch(this.state){case 0:{d.draw(t,"vanilla_tile_covered",0,0,1,1);break}case 1:{d.draw(t,"vanilla_tile_covered",0,0,1,1),d.draw(t,"flag",0,0,1,1);break}case 2:{d.draw(t,"vanilla_tile_revealed",0,0,1,1),this.isMine?d.draw(t,"bomb",0,0,1,1):d.draw(t,H(this.minesNearby()),0,0,1,1);break}}}}class ge extends V{constructor(t,e,s){const a=W(t.tileSeed,e,s,0)>.625;super(t,e,s,a)}render(t){switch(this.state){case 0:{d.draw(t,"chocolate_tile_covered",0,0,1,1);break}case 1:{d.draw(t,"chocolate_tile_covered",0,0,1,1),d.draw(t,"flag",0,0,1,1);break}case 2:{d.draw(t,"chocolate_tile_revealed",0,0,1,1),this.isMine?d.draw(t,"bomb",0,0,1,1):d.draw(t,H(this.minesNearby()),0,0,1,1);break}}}}function $(r,t,e,s){const a=Math.floor(e/t),i=Math.floor(s/t),l=(a+i%2)%2==0,o=Math.abs(e%t)+Math.abs(s%t)*t,c=Math.floor(W(r.tileSeed,a,i,0)*t**2),f=l?o!=c:o==c;return{isDark:l,isMine:f}}class be extends V{constructor(e,s,a){const{isDark:i,isMine:l}=$(e,2,s,a);super(e,s,a,l);m(this,"isDark");this.isDark=i}render(e){switch(this.state){case 0:{d.draw(e,this.isDark?"waffle_tile_covered_dark":"waffle_tile_covered_light",0,0,1,1);break}case 1:{d.draw(e,this.isDark?"waffle_tile_covered_dark":"waffle_tile_covered_light",0,0,1,1),d.draw(e,"flag",0,0,1,1);break}case 2:{d.draw(e,this.isDark?"waffle_tile_revealed_dark":"waffle_tile_revealed_light",0,0,1,1),this.isMine?d.draw(e,"bomb",0,0,1,1):d.draw(e,H(this.minesNearby()),0,0,1,1);break}}}}class ve extends V{constructor(e,s,a){const{isDark:i,isMine:l}=$(e,3,s,a);super(e,s,a,l);m(this,"isDark");this.isDark=i}render(e){switch(this.state){case 0:{d.draw(e,this.isDark?"stroopwafel_tile_covered_dark":"stroopwafel_tile_covered_light",0,0,1,1);break}case 1:{d.draw(e,this.isDark?"stroopwafel_tile_covered_dark":"stroopwafel_tile_covered_light",0,0,1,1),d.draw(e,"flag",0,0,1,1);break}case 2:{d.draw(e,this.isDark?"stroopwafel_tile_revealed_dark":"stroopwafel_tile_revealed_light",0,0,1,1),this.isMine?d.draw(e,"bomb",0,0,1,1):d.draw(e,H(this.minesNearby()),0,0,1,1);break}}}}const ke={type:"collection",weight:1,scale:24,smoothness:.8,biomes:[{type:"collection",weight:5,scale:24,smoothness:.8,biomes:[{type:"biome",weight:3,tile:pe},{type:"biome",weight:1,tile:ge}]},{type:"collection",weight:2,scale:64,smoothness:0,biomes:[{type:"biome",weight:1,tile:be},{type:"biome",weight:2,tile:ve}]}]};function Me(r,t,e,s,a){const i=B(r,!1),l=K(i(),t,e)*s,o=K(i(),t,e)*s;return de(i(),t+l,e+o,a)}function ye(r,t,e){const s=B(r.biomeSeed,!1);let a=ke;for(;a.type=="collection";){const i=Me(s(),t/a.scale,e/a.scale,a.smoothness,a.biomes.map(l=>l.weight));a=a.biomes[i]}return new a.tile(r,t,e)}function*Te(r,t){let e=r,s=t,a=1,i=1;for(;;){for(;2*e*a<i;)yield{x:e,y:s},e+=a;for(;2*s*a<i;)yield{x:e,y:s},s+=a;a=-1*a,i+=1}}class xe{constructor(t){m(this,"seed");m(this,"tileSeed");m(this,"biomeSeed");m(this,"loadedChunks",{});this.seed=t;const e=B(this.seed,!1);this.tileSeed=e(),this.biomeSeed=e()}generateTile(t,e){return ye(this,t,e)}getChunk(t,e){const s=this.loadedChunks[`${t},${e}`];return s||new Q(this,t,e)}getGeneratedChunk(t,e){const s=this.getChunk(t,e);if(s.isGenerated())return s;const a=s.generate();return this.loadedChunks[`${t},${e}`]=a,a}getTile(t,e){const s=Math.floor(t/y),a=Math.floor(e/y);return this.getGeneratedChunk(s,a).getTileAbsolute(t,e)}flag(t,e){return this.getTile(t,e).flag()}reveal(t,e,s=!0){const a=this.getTile(t,e);if(a.reveal(),a.numMines()>0)return!0;if(a.minesNearby()>0)if(s){let o=!1;if(a.flagsNearby()==a.minesNearby())for(const c of a.searchPattern)this.reveal(a.x+c.x,a.y+c.y,!1)&&(o=!0);return o}else return!1;let i=[],l=[a];for(;l.length>0;){const o=l.pop();i.push(o);for(const c of o.searchPattern){const f=this.getTile(o.x+c.x,o.y+c.y);l.some(w=>w.x==f.x&&w.y==f.y)||i.some(w=>w.x==f.x&&w.y==f.y)||(f.minesNearby()==0?l.push(f):i.push(f))}}return i.forEach(o=>o.reveal()),!1}closest0(t,e){for(const{x:s,y:a}of Te(t,e)){const i=this.getTile(s,a);if(i.numMines()==0&&i.minesNearby()==0)return{x:s,y:a}}throw new Error("This error should never happen, it's just here to make TypeScript happy.")}}const Ze=(r,t)=>{const e=new ResizeObserver(()=>{t(r.clientWidth,r.clientHeight)});return e.observe(r),{destroy(){e.unobserve(r),e.disconnect()}}};function O(r){let t,e,s=r[6].x+"",a,i,l=r[6].y+"",o,c,f,w,p,C,_=Math.floor(r[6].x/y)+"",M,b,T=Math.floor(r[6].y/y)+"",x,h;return{c(){t=E("span"),e=X("Tile: "),a=X(s),i=L(),o=X(l),c=L(),f=E("br"),w=L(),p=E("span"),C=X("Chunk: "),M=X(_),b=L(),x=X(T),h=L()},l(n){t=Y(n,"SPAN",{});var u=N(t);e=D(u,"Tile: "),a=D(u,s),i=P(u),o=D(u,l),u.forEach(k),c=P(n),f=Y(n,"BR",{}),w=P(n),p=Y(n,"SPAN",{});var v=N(p);C=D(v,"Chunk: "),M=D(v,_),b=P(v),x=D(v,T),v.forEach(k),h=P(n)},m(n,u){S(n,t,u),g(t,e),g(t,a),g(t,i),g(t,o),S(n,c,u),S(n,f,u),S(n,w,u),S(n,p,u),g(p,C),g(p,M),g(p,b),g(p,x),S(n,h,u)},p(n,u){u&64&&s!==(s=n[6].x+"")&&A(a,s),u&64&&l!==(l=n[6].y+"")&&A(o,l),u&64&&_!==(_=Math.floor(n[6].x/y)+"")&&A(M,_),u&64&&T!==(T=Math.floor(n[6].y/y)+"")&&A(x,T)},d(n){n&&(k(t),k(c),k(f),k(w),k(p),k(h))}}}function J(r){let t=Math.round(r[5]*10)/10+"",e,s;return{c(){e=X(t),s=X("ms")},l(a){e=D(a,t),s=D(a,"ms")},m(a,i){S(a,e,i),S(a,s,i)},p(a,i){i&32&&t!==(t=Math.round(a[5]*10)/10+"")&&A(e,t)},d(a){a&&(k(e),k(s))}}}function Ee(r){let t,e,s,a,i,l,o,c,f=`Left Click: Reveal tile<br/>
                    Right Click: Flag tile<br/>
                    Middle Click: Drag view<br/>
                    Scroll Wheel: Zoom view<br/>`,w,p,C,_,M,b,T,x,h,n=r[6]&&O(r),u=r[5]!==null&&J(r);return{c(){t=E("div"),e=E("canvas"),a=L(),i=E("div"),l=E("div"),o=E("div"),c=E("span"),c.innerHTML=f,w=L(),n&&n.c(),p=E("br"),C=L(),_=E("span"),M=X("Frame "),b=X(r[4]),T=L(),u&&u.c(),this.h()},l(v){t=Y(v,"DIV",{class:!0});var Z=N(t);e=Y(Z,"CANVAS",{class:!0}),N(e).forEach(k),a=P(Z),i=Y(Z,"DIV",{class:!0});var q=N(i);l=Y(q,"DIV",{class:!0});var j=N(l);o=Y(j,"DIV",{class:!0});var I=N(o);c=Y(I,"SPAN",{"data-svelte-h":!0}),ue(c)!=="svelte-kehkvw"&&(c.innerHTML=f),w=P(I),n&&n.l(I),p=Y(I,"BR",{}),C=P(I),_=Y(I,"SPAN",{});var G=N(_);M=D(G,"Frame "),b=D(G,r[4]),T=P(G),u&&u.l(G),G.forEach(k),I.forEach(k),j.forEach(k),q.forEach(k),Z.forEach(k),this.h()},h(){R(e,"class","w-full h-full col-start-1 col-end-1 row-start-1 row-end-1"),R(o,"class","text-white font-bold"),R(l,"class","float-right pointer-events-auto m-4 p-4 bg-zinc-800 bg-opacity-70 outline outline-zinc-600 rounded-lg"),R(i,"class","w-full h-full col-start-1 col-end-1 row-start-1 row-end-1 pointer-events-none"),R(t,"class","w-screen h-screen grid grid-cols-1 grid-rows-1")},m(v,Z){S(v,t,Z),g(t,e),r[7](e),g(t,a),g(t,i),g(i,l),g(l,o),g(o,c),g(o,w),n&&n.m(o,null),g(o,p),g(o,C),g(o,_),g(_,M),g(_,b),g(_,T),u&&u.m(_,null),x||(h=[re(s=Ze.call(null,e,r[8])),F(e,"mousedown",r[9]),F(e,"mouseup",r[10]),F(e,"mousemove",r[11]),F(e,"wheel",r[12],{passive:!0}),F(e,"contextmenu",Ye)],x=!0)},p(v,[Z]){s&&ae(s.update)&&Z&77&&s.update.call(null,v[8]),v[6]?n?n.p(v,Z):(n=O(v),n.c(),n.m(o,p)):n&&(n.d(1),n=null),Z&16&&A(b,v[4]),v[5]!==null?u?u.p(v,Z):(u=J(v),u.c(),u.m(_,null)):u&&(u.d(1),u=null)},i:z,o:z,d(v){v&&k(t),r[7](null),n&&n.d(),u&&u.d(),x=!1,ie(h)}}}const Ye=r=>{r.preventDefault()};function Ce(r,t,e){let s,a,i,l=!1,o=-1,c=0,f=null;const w=()=>{if(cancelAnimationFrame(o),o=requestAnimationFrame(w),l){e(3,l=!1),e(4,c++,c);const h=performance.now();i.render(),e(5,f=performance.now()-h)}};let p=null;ne(()=>{const h=parseInt(new URL(location.href).searchParams.get("seed")??"0");e(1,a=new xe(h));const n=a.closest0(0,0);a.reveal(n.x,n.y),e(2,i=new me(a,s)),setTimeout(()=>{i.cameraTranslate(s.width/2,s.height/2),e(3,l=!0)},100),d.onLoad(()=>{e(3,l=!0)}),console.log(a),w()}),oe(()=>{try{location.reload()}catch{}});function C(h){le[h?"unshift":"push"](()=>{s=h,e(0,s)})}return[s,a,i,l,c,f,p,C,(h,n)=>{e(0,s.width=h,s),e(0,s.height=n,s),i.cameraScale(1),e(6,p=null),e(3,l=!0)},h=>{if(document.pointerLockElement!=s){if(h.button==1)s.requestPointerLock(),h.preventDefault();else if(h.button==0){h.preventDefault();const n=i.cameraPos(h.offsetX,h.offsetY);a.reveal(n.x,n.y),e(3,l=!0)}else if(h.button==2){h.preventDefault();const n=i.cameraPos(h.offsetX,h.offsetY);a.flag(n.x,n.y),e(3,l=!0)}}},h=>{document.pointerLockElement==s&&h.button==1&&document.exitPointerLock()},h=>{e(6,p=i.cameraPos(h.offsetX,h.offsetY)),document.pointerLockElement==s&&(i.cameraTranslate(h.movementX,h.movementY),e(3,l=!0))},h=>{const n=h.deltaY>0?.9:1.1;i.cameraZoom!=i.cameraScale(n)&&(e(6,p=i.cameraPos(h.offsetX,h.offsetY)),e(3,l=!0))}]}class Le extends ce{constructor(t){super(),he(this,t,Ce,Ee,se,{})}}export{Le as component};
