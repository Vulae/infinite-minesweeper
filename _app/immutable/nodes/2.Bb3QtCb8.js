var z=Object.defineProperty;var H=(r,t,e)=>t in r?z(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var h=(r,t,e)=>(H(r,typeof t!="symbol"?t+"":t,e),e);import{s as N,x as I,i as V,n as W,r as F,o as q,y as B,e as j}from"../chunks/scheduler.B8wtCbz7.js";import{S as K,i as O,e as b,s as L,c as x,a as k,d as p,f as S,y as U,o as T,g as A,h as g,z as Z,t as X,b as E,j as G}from"../chunks/index.Dt0ReVwJ.js";class J{constructor(t,e){h(this,"textures");h(this,"src");h(this,"img");this.src=t,this.img=document.createElement("img"),this.img.src=this.src,this.textures=e}awaitLoad(){return new Promise((t,e)=>{if(this.img.naturalWidth!==0)return t();const s=()=>{this.img.removeEventListener("load",s),this.img.removeEventListener("error",a),t()},a=()=>{this.img.removeEventListener("load",s),this.img.removeEventListener("error",a),e()};this.img.addEventListener("load",s),this.img.addEventListener("error",a)})}onLoad(t){this.awaitLoad().then(()=>t(this))}draw(t,e,s,a,n,i){const[c,u,l,d]=this.textures[e];t.drawImage(this.img,c,u,l,d,s,a,n,i)}}const y=new J("/infinite-sweeper/tileset.png",{null:[0,0,16,16],tile_covered:[16,0,16,16],tile_revealed:[16,16,16,16],bomb:[32,0,16,16],explosion:[32,16,16,16],flag:[32,32,16,16],number_0:[48,0,16,16],number_1:[48,16,16,16],number_2:[48,32,16,16],number_3:[48,48,16,16],number_4:[48,64,16,16],number_5:[48,80,16,16],number_6:[48,96,16,16],number_7:[48,112,16,16],number_8:[48,128,16,16]});function Q(r){switch(r){case 0:return"number_0";case 1:return"number_1";case 2:return"number_2";case 3:return"number_3";case 4:return"number_4";case 5:return"number_5";case 6:return"number_6";case 7:return"number_7";case 8:return"number_8";default:return"null"}}class ${constructor(t,e,s){h(this,"world");h(this,"x");h(this,"y");this.world=t,this.x=e,this.y=s}nearby(){let t=0;for(const e of this.pattern)t+=this.world.getTile(this.x+e.x,this.y+e.y).mines();return t}}class ee extends ${constructor(e,s,a){super(e,s,a);h(this,"isMine");h(this,"state","covered");h(this,"pattern",[{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:-1}]);this.isMine=this.world.rng.tileRNG(this.x,this.y,0)>.7}mines(){return this.isMine?1:0}flag(){this.state!="revealed"&&(this.state=this.state=="covered"?"flagged":"covered")}reveal(){return this.state="revealed",this.isMine}render(e){this.state=="covered"?y.draw(e,"tile_covered",0,0,1,1):this.state=="flagged"?(y.draw(e,"tile_covered",0,0,1,1),y.draw(e,"flag",0,0,1,1)):this.state=="revealed"&&(y.draw(e,"tile_revealed",0,0,1,1),this.isMine?y.draw(e,"bomb",0,0,1,1):y.draw(e,Q(this.nearby()),0,0,1,1))}}function te(r,t){return()=>{r|=0,r=r+2654435769|0;let e=r^r>>>16;e=Math.imul(e,569420461),e=e^e>>>15,e=Math.imul(e,1935289751);const s=(e=e^e>>>15)>>>0;return t?s/4294967296:s}}function se(r,t,e,s){return r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=t,r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=e,r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=s,r^=r<<16|r>>>15,r=r*2158630691+3333583613&4294967295,(r>>>0)/4294967295}class re{constructor(t){h(this,"seed");h(this,"seedTile");this.seed=t;const e=te(this.seed,!1);this.seedTile=e()}tileRNG(t,e,s){return se(this.seedTile,t,e,s)}}class ae{constructor(t,e){h(this,"world");h(this,"canvas");h(this,"ctx");h(this,"cameraX",0);h(this,"cameraY",0);h(this,"cameraZoom",32);h(this,"cameraMinZoom",4);h(this,"cameraMaxZoom",64);this.world=t,this.canvas=e;const s=this.canvas.getContext("2d");if(!s)throw new Error("This browser or machine does not support canvas 2d.");this.ctx=s}cameraWidth(){return this.canvas.width/this.cameraZoom}cameraHeight(){return this.canvas.height/this.cameraZoom}cameraTranslate(t,e){this.cameraX-=t/this.cameraZoom,this.cameraY-=e/this.cameraZoom}cameraScale(t){const e=this.cameraX+this.cameraWidth()*.5,s=this.cameraY+this.cameraHeight()*.5;this.cameraZoom*=t,this.canvas.width/this.cameraZoom<this.cameraMinZoom&&(this.cameraZoom=this.canvas.width/this.cameraMinZoom),this.canvas.height/this.cameraZoom<this.cameraMinZoom&&(this.cameraZoom=this.canvas.height/this.cameraMinZoom),this.canvas.width/this.cameraZoom>this.cameraMaxZoom&&(this.cameraZoom=this.canvas.width/this.cameraMaxZoom),this.canvas.height/this.cameraZoom>this.cameraMaxZoom&&(this.cameraZoom=this.canvas.height/this.cameraMaxZoom);const a=this.cameraX+this.cameraWidth()*.5,n=this.cameraY+this.cameraHeight()*.5;this.cameraX-=a-e,this.cameraY-=n-s}cameraBounds(t=0){return{minX:Math.floor(this.cameraX-t),minY:Math.floor(this.cameraY-t),maxX:Math.ceil(this.cameraX+this.cameraWidth()+t),maxY:Math.ceil(this.cameraY+this.cameraHeight()+t)}}cameraPos(t,e){return{x:Math.floor(t/this.cameraZoom+this.cameraX),y:Math.floor(e/this.cameraZoom+this.cameraY)}}renderWorld(){this.ctx.imageSmoothingEnabled=!1,this.ctx.scale(this.cameraZoom,this.cameraZoom),this.ctx.translate(-this.cameraX,-this.cameraY);const t=this.cameraBounds(1);for(let e=t.minX;e<t.maxX;e++)for(let s=t.minY;s<t.maxY;s++)this.ctx.save(),this.ctx.translate(e,s),this.ctx.scale(1.01,1.01),this.world.getTile(e,s).render(this.ctx),this.ctx.restore();this.ctx.imageSmoothingEnabled=!0}render(){this.ctx.reset(),this.ctx.fillStyle="purple",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderWorld()}}const w=32;class R{constructor(t,e,s){h(this,"world");h(this,"chunkX");h(this,"chunkY");this.world=t,this.chunkX=e,this.chunkY=s}isGenerated(){return this instanceof P}generate(){if(this.isGenerated())throw new Error("Cannot generate an already generated chunk.");console.log(`Generating new chunk: ${this.chunkX}, ${this.chunkY}`);const t=[];for(let e=0;e<w;e++)for(let s=0;s<w;s++){const a=this.world.generateTile(this.chunkX*w+s,this.chunkY*w+e);t.push(a)}return new P(this.world,this.chunkX,this.chunkY,t)}}class P extends R{constructor(e,s,a,n){super(e,s,a);h(this,"tiles");if(this.tiles=n,this.tiles.length!=w*w)throw new Error("GeneratedChunk incorrect tiles length.")}getTileAbsolute(e,s){return this.getTile(e-this.chunkX*w,s-this.chunkY*w)}getTile(e,s){return this.tiles[e+s*w]}}function*ne(r,t){let e=r,s=t,a=1,n=1;for(;;){for(;2*e*a<n;)yield{x:e,y:s},e+=a;for(;2*s*a<n;)yield{x:e,y:s},s+=a;a=-1*a,n+=1}}class ie{constructor(t){h(this,"rng");h(this,"loadedChunks",{});this.rng=t}generateTile(t,e){return new ee(this,t,e)}getChunk(t,e){const s=this.loadedChunks[`${t},${e}`];return s||new R(this,t,e)}getGeneratedChunk(t,e){const s=this.getChunk(t,e);if(s.isGenerated())return s;const a=s.generate();return this.loadedChunks[`${t},${e}`]=a,a}getTile(t,e){const s=Math.floor(t/w),a=Math.floor(e/w);return this.getGeneratedChunk(s,a).getTileAbsolute(t,e)}flag(t,e){return this.getTile(t,e).flag()}reveal(t,e){const s=this.getTile(t,e);if(s.reveal())return!0;if(s.nearby()>0)return!1;let n=[],i=[s];for(;i.length>0;){const c=i.pop();n.push(c);for(const u of c.pattern){const l=this.getTile(c.x+u.x,c.y+u.y);i.some(d=>d.x==l.x&&d.y==l.y)||n.some(d=>d.x==l.x&&d.y==l.y)||(l.nearby()==0?i.push(l):n.push(l))}}return n.forEach(c=>c.reveal()),!1}revealClosest0(t,e){for(const{x:s,y:a}of ne(t,e)){const n=this.getTile(s,a);if(n.mines()==0&&n.nearby()==0){this.reveal(n.x,n.y);break}}}}const oe=(r,t)=>{const e=new ResizeObserver(()=>{t(r.clientWidth,r.clientHeight)});return e.observe(r),{destroy(){e.unobserve(r),e.disconnect()}}};function D(r){let t,e,s=r[4].x+"",a,n,i=r[4].y+"",c;return{c(){t=b("span"),e=X("Tile: "),a=X(s),n=L(),c=X(i)},l(u){t=x(u,"SPAN",{});var l=k(t);e=E(l,"Tile: "),a=E(l,s),n=S(l),c=E(l,i),l.forEach(p)},m(u,l){A(u,t,l),g(t,e),g(t,a),g(t,n),g(t,c)},p(u,l){l&16&&s!==(s=u[4].x+"")&&G(a,s),l&16&&i!==(i=u[4].y+"")&&G(c,i)},d(u){u&&p(t)}}}function le(r){let t,e,s,a,n,i,c,u,l=`Left Click: Reveal tile<br/>
                    Right Click: Flag tile<br/>
                    Middle Click: Drag view<br/>
                    Scroll Wheel: Zoom view<br/>`,d,M,C,m=r[4]&&D(r);return{c(){t=b("div"),e=b("canvas"),a=L(),n=b("div"),i=b("div"),c=b("div"),u=b("span"),u.innerHTML=l,d=L(),m&&m.c(),this.h()},l(f){t=x(f,"DIV",{class:!0});var v=k(t);e=x(v,"CANVAS",{class:!0}),k(e).forEach(p),a=S(v),n=x(v,"DIV",{class:!0});var o=k(n);i=x(o,"DIV",{class:!0});var _=k(i);c=x(_,"DIV",{class:!0});var Y=k(c);u=x(Y,"SPAN",{"data-svelte-h":!0}),U(u)!=="svelte-kehkvw"&&(u.innerHTML=l),d=S(Y),m&&m.l(Y),Y.forEach(p),_.forEach(p),o.forEach(p),v.forEach(p),this.h()},h(){T(e,"class","w-full h-full col-start-1 col-end-1 row-start-1 row-end-1"),T(c,"class","text-white font-bold"),T(i,"class","float-right pointer-events-auto m-4 p-4 bg-zinc-800 bg-opacity-70 outline outline-zinc-600 rounded-lg"),T(n,"class","w-full h-full col-start-1 col-end-1 row-start-1 row-end-1 pointer-events-none"),T(t,"class","w-screen h-screen grid grid-cols-1 grid-rows-1")},m(f,v){A(f,t,v),g(t,e),r[5](e),g(t,a),g(t,n),g(n,i),g(i,c),g(c,u),g(c,d),m&&m.m(c,null),M||(C=[I(s=oe.call(null,e,r[6])),Z(e,"mousedown",r[7]),Z(e,"mouseup",r[8]),Z(e,"mousemove",r[9]),Z(e,"wheel",r[10],{passive:!0}),Z(e,"contextmenu",ce)],M=!0)},p(f,[v]){s&&V(s.update)&&v&29&&s.update.call(null,f[6]),f[4]?m?m.p(f,v):(m=D(f),m.c(),m.m(c,null)):m&&(m.d(1),m=null)},i:W,o:W,d(f){f&&p(t),r[5](null),m&&m.d(),M=!1,F(C)}}}const ce=r=>{r.preventDefault()};function he(r,t,e){let s,a,n,i=!1,c=-1;const u=()=>{cancelAnimationFrame(c),c=requestAnimationFrame(u),i&&(e(3,i=!1),n.render())};let l=null;q(()=>{e(1,a=new ie(new re(0))),a.revealClosest0(0,0),e(2,n=new ae(a,s)),setTimeout(()=>{n.cameraTranslate(s.width/2,s.height/2),e(3,i=!0)},100),y.onLoad(()=>{e(3,i=!0)}),console.log(a),u()}),B(()=>{try{location.reload()}catch{}});function d(o){j[o?"unshift":"push"](()=>{s=o,e(0,s)})}return[s,a,n,i,l,d,(o,_)=>{e(0,s.width=o,s),e(0,s.height=_,s),n.cameraScale(1),e(4,l=null),e(3,i=!0)},o=>{if(document.pointerLockElement!=s){if(o.button==1)s.requestPointerLock(),o.preventDefault();else if(o.button==0){o.preventDefault();const _=n.cameraPos(o.offsetX,o.offsetY);a.reveal(_.x,_.y),e(3,i=!0)}else if(o.button==2){o.preventDefault();const _=n.cameraPos(o.offsetX,o.offsetY);a.flag(_.x,_.y),e(3,i=!0)}}},o=>{document.pointerLockElement==s&&o.button==1&&document.exitPointerLock()},o=>{e(4,l=n.cameraPos(o.offsetX,o.offsetY)),document.pointerLockElement==s&&(n.cameraTranslate(o.movementX,o.movementY),e(3,i=!0))},o=>{n.cameraScale(o.deltaY>0?.9:1.1),e(4,l=n.cameraPos(o.offsetX,o.offsetY)),e(3,i=!0)}]}class fe extends K{constructor(t){super(),O(this,t,he,le,N,{})}}export{fe as component};
