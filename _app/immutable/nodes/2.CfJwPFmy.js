var z=Object.defineProperty;var H=(r,t,e)=>t in r?z(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var h=(r,t,e)=>(H(r,typeof t!="symbol"?t+"":t,e),e);import{s as I,x as V,i as q,n as P,r as j,o as B,y as U,e as K}from"../chunks/scheduler.B8wtCbz7.js";import{S as O,i as J,e as x,s as L,c as y,a as k,d as b,f as N,y as Q,o as M,g as R,h as _,z as T,t as X,b as C,j as F}from"../chunks/index.Dt0ReVwJ.js";class ${constructor(t,e){h(this,"textures");h(this,"src");h(this,"img");this.src=t,this.img=document.createElement("img"),this.img.src=this.src,this.textures=e}awaitLoad(){return new Promise((t,e)=>{if(this.img.naturalWidth!==0)return t();const s=()=>{this.img.removeEventListener("load",s),this.img.removeEventListener("error",a),t()},a=()=>{this.img.removeEventListener("load",s),this.img.removeEventListener("error",a),e()};this.img.addEventListener("load",s),this.img.addEventListener("error",a)})}onLoad(t){this.awaitLoad().then(()=>t(this))}draw(t,e,s,a,n,o){const[l,u,c,f]=this.textures[e];t.drawImage(this.img,l,u,c,f,s,a,n,o)}}const w=new $("/infinite-sweeper/tileset.png",{null:[0,0,16,16],bomb:[16,0,16,16],explosion:[16,16,16,16],flag:[32,16,16,16],number_0:[48,0,16,16],number_1:[48,16,16,16],number_2:[48,32,16,16],number_3:[48,48,16,16],number_4:[48,64,16,16],number_5:[48,80,16,16],number_6:[48,96,16,16],number_7:[48,112,16,16],number_8:[48,128,16,16],vanilla_tile_covered:[64,0,16,16],vanilla_tile_revealed:[80,0,16,16],chocolate_tile_covered:[64,16,16,16],chocolate_tile_revealed:[80,16,16,16]});function W(r){switch(r){case 0:return"number_0";case 1:return"number_1";case 2:return"number_2";case 3:return"number_3";case 4:return"number_4";case 5:return"number_5";case 6:return"number_6";case 7:return"number_7";case 8:return"number_8";default:return"null"}}class ee{constructor(t,e,s){h(this,"world");h(this,"x");h(this,"y");this.world=t,this.x=e,this.y=s}minesNearby(){let t=0;for(const e of this.searchPattern)t+=this.world.getTile(this.x+e.x,this.y+e.y).numMines();return t}flagsNearby(){let t=0;for(const e of this.searchPattern)t+=this.world.getTile(this.x+e.x,this.y+e.y).numFlags();return t}}class D extends ee{constructor(e,s,a){super(e,s,a);h(this,"_numMines");h(this,"_revealed",!1);h(this,"_numFlags",0);h(this,"_numFlagsMax",1);h(this,"searchPattern",[{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:-1}]);this._numMines=this.world.rng.tileRNG(this.x,this.y,0)>.875?1:0}render(e){this._revealed?(w.draw(e,"vanilla_tile_revealed",0,0,1,1),this._numMines>0?w.draw(e,"bomb",0,0,1,1):w.draw(e,W(this.minesNearby()),0,0,1,1)):(w.draw(e,"vanilla_tile_covered",0,0,1,1),this._numFlags>0&&w.draw(e,"flag",0,0,1,1))}numMines(){return this._numMines}numFlags(){return this._numFlags}flag(){this._revealed||(this._numFlags++,this._numFlags>this._numFlagsMax&&(this._numFlags=0))}reveal(){this._numFlags>0||(this._revealed=!0)}}class te extends D{constructor(e,s,a){super(e,s,a);h(this,"_numMines");this._numMines=this.world.rng.tileRNG(this.x,this.y,0)>.6?1:0}render(e){this._revealed?(w.draw(e,"chocolate_tile_revealed",0,0,1,1),this._numMines>0?w.draw(e,"bomb",0,0,1,1):w.draw(e,W(this.minesNearby()),0,0,1,1)):(w.draw(e,"chocolate_tile_covered",0,0,1,1),this._numFlags>0&&w.draw(e,"flag",0,0,1,1))}}function se(r,t){return()=>{r|=0,r=r+2654435769|0;let e=r^r>>>16;e=Math.imul(e,569420461),e=e^e>>>15,e=Math.imul(e,1935289751);const s=(e=e^e>>>15)>>>0;return t?s/4294967296:s}}function re(r,t,e,s){return r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=t,r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=e,r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=s,r^=r<<16|r>>>15,r=r*2158630691+3333583613&4294967295,(r>>>0)/4294967295}class ae{constructor(t){h(this,"seed");h(this,"seedTile");this.seed=t;const e=se(this.seed,!1);this.seedTile=e()}tileRNG(t,e,s){return re(this.seedTile,t,e,s)}}class ne{constructor(t,e){h(this,"world");h(this,"canvas");h(this,"ctx");h(this,"cameraX",0);h(this,"cameraY",0);h(this,"cameraZoom",32);h(this,"cameraMinZoom",4);h(this,"cameraMaxZoom",64);this.world=t,this.canvas=e;const s=this.canvas.getContext("2d");if(!s)throw new Error("This browser or machine does not support canvas 2d.");this.ctx=s}cameraWidth(){return this.canvas.width/this.cameraZoom}cameraHeight(){return this.canvas.height/this.cameraZoom}cameraTranslate(t,e){this.cameraX-=t/this.cameraZoom,this.cameraY-=e/this.cameraZoom}cameraScale(t){const e=this.cameraX+this.cameraWidth()*.5,s=this.cameraY+this.cameraHeight()*.5;this.cameraZoom*=t,this.canvas.width/this.cameraZoom<this.cameraMinZoom&&(this.cameraZoom=this.canvas.width/this.cameraMinZoom),this.canvas.height/this.cameraZoom<this.cameraMinZoom&&(this.cameraZoom=this.canvas.height/this.cameraMinZoom),this.canvas.width/this.cameraZoom>this.cameraMaxZoom&&(this.cameraZoom=this.canvas.width/this.cameraMaxZoom),this.canvas.height/this.cameraZoom>this.cameraMaxZoom&&(this.cameraZoom=this.canvas.height/this.cameraMaxZoom);const a=this.cameraX+this.cameraWidth()*.5,n=this.cameraY+this.cameraHeight()*.5;this.cameraX-=a-e,this.cameraY-=n-s}cameraBounds(t=0){return{minX:Math.floor(this.cameraX-t),minY:Math.floor(this.cameraY-t),maxX:Math.ceil(this.cameraX+this.cameraWidth()+t),maxY:Math.ceil(this.cameraY+this.cameraHeight()+t)}}cameraPos(t,e){return{x:Math.floor(t/this.cameraZoom+this.cameraX),y:Math.floor(e/this.cameraZoom+this.cameraY)}}renderWorld(){this.ctx.imageSmoothingEnabled=!1,this.ctx.scale(this.cameraZoom,this.cameraZoom),this.ctx.translate(-this.cameraX,-this.cameraY);const t=this.cameraBounds(1);for(let e=t.minX;e<t.maxX;e++)for(let s=t.minY;s<t.maxY;s++)this.ctx.save(),this.ctx.translate(e,s),this.ctx.scale(1.01,1.01),this.world.getTile(e,s).render(this.ctx),this.ctx.restore();this.ctx.imageSmoothingEnabled=!0}render(){this.ctx.reset(),this.ctx.fillStyle="purple",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderWorld()}}const v=32;class A{constructor(t,e,s){h(this,"world");h(this,"chunkX");h(this,"chunkY");this.world=t,this.chunkX=e,this.chunkY=s}isGenerated(){return this instanceof S}generate(){if(this.isGenerated())throw new Error("Cannot generate an already generated chunk.");console.log(`Generating new chunk: ${this.chunkX}, ${this.chunkY}`);const t=[];for(let e=0;e<v;e++)for(let s=0;s<v;s++){const a=this.world.generateTile(this.chunkX*v+s,this.chunkY*v+e);t.push(a)}return new S(this.world,this.chunkX,this.chunkY,t)}}class S extends A{constructor(e,s,a,n){super(e,s,a);h(this,"tiles");if(this.tiles=n,this.tiles.length!=v*v)throw new Error("GeneratedChunk incorrect tiles length.")}getTileAbsolute(e,s){return this.getTile(e-this.chunkX*v,s-this.chunkY*v)}getTile(e,s){return this.tiles[e+s*v]}}function*ie(r,t){let e=r,s=t,a=1,n=1;for(;;){for(;2*e*a<n;)yield{x:e,y:s},e+=a;for(;2*s*a<n;)yield{x:e,y:s},s+=a;a=-1*a,n+=1}}class oe{constructor(t){h(this,"rng");h(this,"loadedChunks",{});this.rng=t}generateTile(t,e){return this.rng.tileRNG(Math.floor(t/16),Math.floor(e/16),-1)<=.5?new D(this,t,e):new te(this,t,e)}getChunk(t,e){const s=this.loadedChunks[`${t},${e}`];return s||new A(this,t,e)}getGeneratedChunk(t,e){const s=this.getChunk(t,e);if(s.isGenerated())return s;const a=s.generate();return this.loadedChunks[`${t},${e}`]=a,a}getTile(t,e){const s=Math.floor(t/v),a=Math.floor(e/v);return this.getGeneratedChunk(s,a).getTileAbsolute(t,e)}flag(t,e){return this.getTile(t,e).flag()}reveal(t,e,s=!0){const a=this.getTile(t,e);if(a.reveal(),a.numMines()>0)return!0;if(a.minesNearby()>0)if(s){let l=!1;if(a.flagsNearby()==a.minesNearby())for(const u of a.searchPattern)this.reveal(a.x+u.x,a.y+u.y,!1)&&(l=!0);return l}else return!1;let n=[],o=[a];for(;o.length>0;){const l=o.pop();n.push(l);for(const u of l.searchPattern){const c=this.getTile(l.x+u.x,l.y+u.y);o.some(f=>f.x==c.x&&f.y==c.y)||n.some(f=>f.x==c.x&&f.y==c.y)||(c.minesNearby()==0?o.push(c):n.push(c))}}return n.forEach(l=>l.reveal()),!1}closest0(t,e){for(const{x:s,y:a}of ie(t,e)){const n=this.getTile(s,a);if(n.numMines()==0&&n.minesNearby()==0)return{x:s,y:a}}throw new Error("This error should never happen, it's just here to make TypeScript happy.")}}const le=(r,t)=>{const e=new ResizeObserver(()=>{t(r.clientWidth,r.clientHeight)});return e.observe(r),{destroy(){e.unobserve(r),e.disconnect()}}};function G(r){let t,e,s=r[4].x+"",a,n,o=r[4].y+"",l;return{c(){t=x("span"),e=X("Tile: "),a=X(s),n=L(),l=X(o)},l(u){t=y(u,"SPAN",{});var c=k(t);e=C(c,"Tile: "),a=C(c,s),n=N(c),l=C(c,o),c.forEach(b)},m(u,c){R(u,t,c),_(t,e),_(t,a),_(t,n),_(t,l)},p(u,c){c&16&&s!==(s=u[4].x+"")&&F(a,s),c&16&&o!==(o=u[4].y+"")&&F(l,o)},d(u){u&&b(t)}}}function he(r){let t,e,s,a,n,o,l,u,c=`Left Click: Reveal tile<br/>
                    Right Click: Flag tile<br/>
                    Middle Click: Drag view<br/>
                    Scroll Wheel: Zoom view<br/>`,f,Z,E,m=r[4]&&G(r);return{c(){t=x("div"),e=x("canvas"),a=L(),n=x("div"),o=x("div"),l=x("div"),u=x("span"),u.innerHTML=c,f=L(),m&&m.c(),this.h()},l(g){t=y(g,"DIV",{class:!0});var p=k(t);e=y(p,"CANVAS",{class:!0}),k(e).forEach(b),a=N(p),n=y(p,"DIV",{class:!0});var i=k(n);o=y(i,"DIV",{class:!0});var d=k(o);l=y(d,"DIV",{class:!0});var Y=k(l);u=y(Y,"SPAN",{"data-svelte-h":!0}),Q(u)!=="svelte-kehkvw"&&(u.innerHTML=c),f=N(Y),m&&m.l(Y),Y.forEach(b),d.forEach(b),i.forEach(b),p.forEach(b),this.h()},h(){M(e,"class","w-full h-full col-start-1 col-end-1 row-start-1 row-end-1"),M(l,"class","text-white font-bold"),M(o,"class","float-right pointer-events-auto m-4 p-4 bg-zinc-800 bg-opacity-70 outline outline-zinc-600 rounded-lg"),M(n,"class","w-full h-full col-start-1 col-end-1 row-start-1 row-end-1 pointer-events-none"),M(t,"class","w-screen h-screen grid grid-cols-1 grid-rows-1")},m(g,p){R(g,t,p),_(t,e),r[5](e),_(t,a),_(t,n),_(n,o),_(o,l),_(l,u),_(l,f),m&&m.m(l,null),Z||(E=[V(s=le.call(null,e,r[6])),T(e,"mousedown",r[7]),T(e,"mouseup",r[8]),T(e,"mousemove",r[9]),T(e,"wheel",r[10],{passive:!0}),T(e,"contextmenu",ce)],Z=!0)},p(g,[p]){s&&q(s.update)&&p&29&&s.update.call(null,g[6]),g[4]?m?m.p(g,p):(m=G(g),m.c(),m.m(l,null)):m&&(m.d(1),m=null)},i:P,o:P,d(g){g&&b(t),r[5](null),m&&m.d(),Z=!1,j(E)}}}const ce=r=>{r.preventDefault()};function ue(r,t,e){let s,a,n,o=!1,l=-1;const u=()=>{cancelAnimationFrame(l),l=requestAnimationFrame(u),o&&(e(3,o=!1),n.render())};let c=null;B(()=>{const i=parseInt(new URL(location.href).searchParams.get("seed")??"0");e(1,a=new oe(new ae(i)));const d=a.closest0(0,0);a.reveal(d.x,d.y),e(2,n=new ne(a,s)),setTimeout(()=>{n.cameraTranslate(s.width/2,s.height/2),e(3,o=!0)},100),w.onLoad(()=>{e(3,o=!0)}),console.log(a),u()}),U(()=>{try{location.reload()}catch{}});function f(i){K[i?"unshift":"push"](()=>{s=i,e(0,s)})}return[s,a,n,o,c,f,(i,d)=>{e(0,s.width=i,s),e(0,s.height=d,s),n.cameraScale(1),e(4,c=null),e(3,o=!0)},i=>{if(document.pointerLockElement!=s){if(i.button==1)s.requestPointerLock(),i.preventDefault();else if(i.button==0){i.preventDefault();const d=n.cameraPos(i.offsetX,i.offsetY);a.reveal(d.x,d.y),e(3,o=!0)}else if(i.button==2){i.preventDefault();const d=n.cameraPos(i.offsetX,i.offsetY);a.flag(d.x,d.y),e(3,o=!0)}}},i=>{document.pointerLockElement==s&&i.button==1&&document.exitPointerLock()},i=>{e(4,c=n.cameraPos(i.offsetX,i.offsetY)),document.pointerLockElement==s&&(n.cameraTranslate(i.movementX,i.movementY),e(3,o=!0))},i=>{n.cameraScale(i.deltaY>0?.9:1.1),e(4,c=n.cameraPos(i.offsetX,i.offsetY)),e(3,o=!0)}]}class ge extends O{constructor(t){super(),J(this,t,ue,he,I,{})}}export{ge as component};
