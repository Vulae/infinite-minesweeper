var $=Object.defineProperty;var ee=(r,t,e)=>t in r?$(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var m=(r,t,e)=>(ee(r,typeof t!="symbol"?t+"":t,e),e);import{s as te,x as se,i as re,n as V,r as ne,o as ae,y as ie,e as oe}from"../chunks/scheduler.B8wtCbz7.js";import{S as le,i as he,e as x,s as F,t as C,c as M,a as N,d as p,f as P,y as ce,b as Z,o as D,g as L,h as f,z as R,j as W}from"../chunks/index.Dt0ReVwJ.js";class ue{constructor(t,e){m(this,"world");m(this,"canvas");m(this,"ctx");m(this,"cameraX",0);m(this,"cameraY",0);m(this,"cameraZoom",32);m(this,"cameraMinZoom",4);m(this,"cameraMaxZoom",64);this.world=t,this.canvas=e;const s=this.canvas.getContext("2d");if(!s)throw new Error("This browser or machine does not support canvas 2d.");this.ctx=s}cameraWidth(){return this.canvas.width/this.cameraZoom}cameraHeight(){return this.canvas.height/this.cameraZoom}cameraTranslate(t,e){this.cameraX-=t/this.cameraZoom,this.cameraY-=e/this.cameraZoom}cameraScale(t){const e=this.cameraX+this.cameraWidth()*.5,s=this.cameraY+this.cameraHeight()*.5;this.cameraZoom*=t,this.canvas.width/this.cameraZoom<this.cameraMinZoom&&(this.cameraZoom=this.canvas.width/this.cameraMinZoom),this.canvas.height/this.cameraZoom<this.cameraMinZoom&&(this.cameraZoom=this.canvas.height/this.cameraMinZoom),this.canvas.width/this.cameraZoom>this.cameraMaxZoom&&(this.cameraZoom=this.canvas.width/this.cameraMaxZoom),this.canvas.height/this.cameraZoom>this.cameraMaxZoom&&(this.cameraZoom=this.canvas.height/this.cameraMaxZoom);const n=this.cameraX+this.cameraWidth()*.5,a=this.cameraY+this.cameraHeight()*.5;return this.cameraX-=n-e,this.cameraY-=a-s,this.cameraZoom}cameraBounds(t=0){return{minX:Math.floor(this.cameraX-t),minY:Math.floor(this.cameraY-t),maxX:Math.ceil(this.cameraX+this.cameraWidth()+t),maxY:Math.ceil(this.cameraY+this.cameraHeight()+t)}}cameraPos(t,e){return{x:Math.floor(t/this.cameraZoom+this.cameraX),y:Math.floor(e/this.cameraZoom+this.cameraY)}}renderWorld(){this.ctx.imageSmoothingEnabled=!1,this.ctx.scale(this.cameraZoom,this.cameraZoom),this.ctx.translate(-this.cameraX,-this.cameraY);const t=this.cameraBounds(1);for(let e=t.minX;e<t.maxX;e++)for(let s=t.minY;s<t.maxY;s++)this.ctx.save(),this.ctx.translate(e,s),this.ctx.scale(1.01,1.01),this.world.getTile(e,s).render(this.ctx),this.ctx.restore();this.ctx.imageSmoothingEnabled=!0}render(){this.ctx.reset(),this.ctx.fillStyle="purple",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderWorld()}}const v=32;class K{constructor(t,e,s){m(this,"world");m(this,"chunkX");m(this,"chunkY");this.world=t,this.chunkX=e,this.chunkY=s}isGenerated(){return this instanceof B}generate(){if(this.isGenerated())throw new Error("Cannot generate an already generated chunk.");console.log(`Generating new chunk: ${this.chunkX}, ${this.chunkY}`);const t=[];for(let e=0;e<v;e++)for(let s=0;s<v;s++){const n=this.world.generateTile(this.chunkX*v+s,this.chunkY*v+e);t.push(n)}return new B(this.world,this.chunkX,this.chunkY,t)}}class B extends K{constructor(e,s,n,a){super(e,s,n);m(this,"tiles");if(this.tiles=a,this.tiles.length!=v*v)throw new Error("GeneratedChunk incorrect tiles length.")}getTileAbsolute(e,s){return this.getTile(e-this.chunkX*v,s-this.chunkY*v)}getTile(e,s){return this.tiles[e+s*v]}}function me(r,t){return()=>{r|=0,r=r+2654435769|0;let e=r^r>>>16;e=Math.imul(e,569420461),e=e^e>>>15,e=Math.imul(e,1935289751);const s=(e=e^e>>>15)>>>0;return t?s/4294967296:s}}function z(r,t,e,s){return r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=t,r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=e,r^=r<<13|r>>>17,r=r*2158630691+3333583613&4294967295,r^=s,r^=r<<16|r>>>15,r=r*2158630691+3333583613&4294967295,(r>>>0)/4294967295}function fe(r,t){t*=r.reduce((e,s)=>e+s,0);for(let e=0;e<r.length;e++)if(t-=r[e],t<=0)return e;throw new Error("Invalid weights")}function q(r,t,e,s){let n=[];for(let o=Math.floor(t)-1;o<Math.ceil(t)+1;o++)for(let u=Math.floor(e)-1;u<Math.ceil(e)+1;u++)n.push({x:o+z(r,o,u,0)-.5,y:u+z(r,o,u,1)-.5,type:fe(s,z(r,o,u,2))});let a=1/0,h=-1;for(const o of n){const u=Math.sqrt((o.x-t)**2+(o.y-e)**2);u<a&&(a=u,h=o.type)}if(h==-1)throw new Error("Voronoi noise error.");return h}class de{constructor(t,e){m(this,"textures");m(this,"src");m(this,"img");this.src=t,this.img=document.createElement("img"),this.img.src=this.src,this.textures=e}awaitLoad(){return new Promise((t,e)=>{if(this.img.naturalWidth!==0)return t();const s=()=>{this.img.removeEventListener("load",s),this.img.removeEventListener("error",n),t()},n=()=>{this.img.removeEventListener("load",s),this.img.removeEventListener("error",n),e()};this.img.addEventListener("load",s),this.img.addEventListener("error",n)})}onLoad(t){this.awaitLoad().then(()=>t(this))}draw(t,e,s,n,a,h){const[o,u,d,g]=this.textures[e];t.drawImage(this.img,o,u,d,g,s,n,a,h)}}const k=new de("/infinite-sweeper/tileset.png",{null:[0,0,16,16],bomb:[16,0,16,16],explosion:[16,16,16,16],flag:[32,16,16,16],number_0:[48,0,16,16],number_1:[48,16,16,16],number_2:[48,32,16,16],number_3:[48,48,16,16],number_4:[48,64,16,16],number_5:[48,80,16,16],number_6:[48,96,16,16],number_7:[48,112,16,16],number_8:[48,128,16,16],vanilla_tile_covered:[64,0,16,16],vanilla_tile_revealed:[80,0,16,16],chocolate_tile_covered:[64,16,16,16],chocolate_tile_revealed:[80,16,16,16]});function O(r){switch(r){case 0:return"number_0";case 1:return"number_1";case 2:return"number_2";case 3:return"number_3";case 4:return"number_4";case 5:return"number_5";case 6:return"number_6";case 7:return"number_7";case 8:return"number_8";default:return"null"}}class _e{constructor(t,e,s){m(this,"world");m(this,"x");m(this,"y");this.world=t,this.x=e,this.y=s}minesNearby(){let t=0;for(const e of this.searchPattern)t+=this.world.getTile(this.x+e.x,this.y+e.y).numMines();return t}flagsNearby(){let t=0;for(const e of this.searchPattern)t+=this.world.getTile(this.x+e.x,this.y+e.y).numFlags();return t}}class J extends _e{constructor(e,s,n){super(e,s,n);m(this,"_numMines");m(this,"_revealed",!1);m(this,"_numFlags",0);m(this,"_numFlagsMax",1);m(this,"searchPattern",[{x:-1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1},{x:1,y:0},{x:1,y:-1},{x:0,y:-1},{x:-1,y:-1}]);this._numMines=z(this.world.tileSeed,this.x,this.y,0)>.875?1:0}render(e){this._revealed?(k.draw(e,"vanilla_tile_revealed",0,0,1,1),this._numMines>0?k.draw(e,"bomb",0,0,1,1):k.draw(e,O(this.minesNearby()),0,0,1,1)):(k.draw(e,"vanilla_tile_covered",0,0,1,1),this._numFlags>0&&k.draw(e,"flag",0,0,1,1))}numMines(){return this._numMines}numFlags(){return this._numFlags}flag(){this._revealed||(this._numFlags++,this._numFlags>this._numFlagsMax&&(this._numFlags=0))}reveal(){this._numFlags>0||(this._revealed=!0)}}class ge extends J{constructor(e,s,n){super(e,s,n);m(this,"_numMines");this._numMines=z(this.world.tileSeed,this.x,this.y,0)>.6?1:0}render(e){this._revealed?(k.draw(e,"chocolate_tile_revealed",0,0,1,1),this._numMines>0?k.draw(e,"bomb",0,0,1,1):k.draw(e,O(this.minesNearby()),0,0,1,1)):(k.draw(e,"chocolate_tile_covered",0,0,1,1),this._numFlags>0&&k.draw(e,"flag",0,0,1,1))}}const Q=[{easyClass:J,hardClass:ge,weight:1}],we=Q.map(r=>r.weight);function pe(r,t,e){const s=q(r.biomeSeed,t/16,e/16,we),n=q(r.chocolateSeed,t/24,e/24,[2,1]),a=Q[s],h=n?a.hardClass:a.easyClass;return new h(r,t,e)}function*be(r,t){let e=r,s=t,n=1,a=1;for(;;){for(;2*e*n<a;)yield{x:e,y:s},e+=n;for(;2*s*n<a;)yield{x:e,y:s},s+=n;n=-1*n,a+=1}}class ve{constructor(t){m(this,"seed");m(this,"tileSeed");m(this,"biomeSeed");m(this,"chocolateSeed");m(this,"loadedChunks",{});this.seed=t;const e=me(this.seed,!1);this.tileSeed=e(),this.biomeSeed=e(),this.chocolateSeed=e()}generateTile(t,e){return pe(this,t,e)}getChunk(t,e){const s=this.loadedChunks[`${t},${e}`];return s||new K(this,t,e)}getGeneratedChunk(t,e){const s=this.getChunk(t,e);if(s.isGenerated())return s;const n=s.generate();return this.loadedChunks[`${t},${e}`]=n,n}getTile(t,e){const s=Math.floor(t/v),n=Math.floor(e/v);return this.getGeneratedChunk(s,n).getTileAbsolute(t,e)}flag(t,e){return this.getTile(t,e).flag()}reveal(t,e,s=!0){const n=this.getTile(t,e);if(n.reveal(),n.numMines()>0)return!0;if(n.minesNearby()>0)if(s){let o=!1;if(n.flagsNearby()==n.minesNearby())for(const u of n.searchPattern)this.reveal(n.x+u.x,n.y+u.y,!1)&&(o=!0);return o}else return!1;let a=[],h=[n];for(;h.length>0;){const o=h.pop();a.push(o);for(const u of o.searchPattern){const d=this.getTile(o.x+u.x,o.y+u.y);h.some(g=>g.x==d.x&&g.y==d.y)||a.some(g=>g.x==d.x&&g.y==d.y)||(d.minesNearby()==0?h.push(d):a.push(d))}}return a.forEach(o=>o.reveal()),!1}closest0(t,e){for(const{x:s,y:n}of be(t,e)){const a=this.getTile(s,n);if(a.numMines()==0&&a.minesNearby()==0)return{x:s,y:n}}throw new Error("This error should never happen, it's just here to make TypeScript happy.")}}const ye=(r,t)=>{const e=new ResizeObserver(()=>{t(r.clientWidth,r.clientHeight)});return e.observe(r),{destroy(){e.unobserve(r),e.disconnect()}}};function j(r){let t,e,s=r[6].x+"",n,a,h=r[6].y+"",o,u,d,g,w,E,b=Math.floor(r[6].x/v)+"",S,Y,T=Math.floor(r[6].y/v)+"",X,l;return{c(){t=x("span"),e=C("Tile: "),n=C(s),a=F(),o=C(h),u=F(),d=x("br"),g=F(),w=x("span"),E=C("Chunk: "),S=C(b),Y=F(),X=C(T),l=F()},l(i){t=M(i,"SPAN",{});var c=N(t);e=Z(c,"Tile: "),n=Z(c,s),a=P(c),o=Z(c,h),c.forEach(p),u=P(i),d=M(i,"BR",{}),g=P(i),w=M(i,"SPAN",{});var _=N(w);E=Z(_,"Chunk: "),S=Z(_,b),Y=P(_),X=Z(_,T),_.forEach(p),l=P(i)},m(i,c){L(i,t,c),f(t,e),f(t,n),f(t,a),f(t,o),L(i,u,c),L(i,d,c),L(i,g,c),L(i,w,c),f(w,E),f(w,S),f(w,Y),f(w,X),L(i,l,c)},p(i,c){c&64&&s!==(s=i[6].x+"")&&W(n,s),c&64&&h!==(h=i[6].y+"")&&W(o,h),c&64&&b!==(b=Math.floor(i[6].x/v)+"")&&W(S,b),c&64&&T!==(T=Math.floor(i[6].y/v)+"")&&W(X,T)},d(i){i&&(p(t),p(u),p(d),p(g),p(w),p(l))}}}function U(r){let t=Math.round(r[5]*10)/10+"",e,s;return{c(){e=C(t),s=C("ms")},l(n){e=Z(n,t),s=Z(n,"ms")},m(n,a){L(n,e,a),L(n,s,a)},p(n,a){a&32&&t!==(t=Math.round(n[5]*10)/10+"")&&W(e,t)},d(n){n&&(p(e),p(s))}}}function xe(r){let t,e,s,n,a,h,o,u,d=`Left Click: Reveal tile<br/>
                    Right Click: Flag tile<br/>
                    Middle Click: Drag view<br/>
                    Scroll Wheel: Zoom view<br/>`,g,w,E,b,S,Y,T,X,l,i=r[6]&&j(r),c=r[5]!==null&&U(r);return{c(){t=x("div"),e=x("canvas"),n=F(),a=x("div"),h=x("div"),o=x("div"),u=x("span"),u.innerHTML=d,g=F(),i&&i.c(),w=x("br"),E=F(),b=x("span"),S=C("Frame "),Y=C(r[4]),T=F(),c&&c.c(),this.h()},l(_){t=M(_,"DIV",{class:!0});var y=N(t);e=M(y,"CANVAS",{class:!0}),N(e).forEach(p),n=P(y),a=M(y,"DIV",{class:!0});var G=N(a);h=M(G,"DIV",{class:!0});var H=N(h);o=M(H,"DIV",{class:!0});var I=N(o);u=M(I,"SPAN",{"data-svelte-h":!0}),ce(u)!=="svelte-kehkvw"&&(u.innerHTML=d),g=P(I),i&&i.l(I),w=M(I,"BR",{}),E=P(I),b=M(I,"SPAN",{});var A=N(b);S=Z(A,"Frame "),Y=Z(A,r[4]),T=P(A),c&&c.l(A),A.forEach(p),I.forEach(p),H.forEach(p),G.forEach(p),y.forEach(p),this.h()},h(){D(e,"class","w-full h-full col-start-1 col-end-1 row-start-1 row-end-1"),D(o,"class","text-white font-bold"),D(h,"class","float-right pointer-events-auto m-4 p-4 bg-zinc-800 bg-opacity-70 outline outline-zinc-600 rounded-lg"),D(a,"class","w-full h-full col-start-1 col-end-1 row-start-1 row-end-1 pointer-events-none"),D(t,"class","w-screen h-screen grid grid-cols-1 grid-rows-1")},m(_,y){L(_,t,y),f(t,e),r[7](e),f(t,n),f(t,a),f(a,h),f(h,o),f(o,u),f(o,g),i&&i.m(o,null),f(o,w),f(o,E),f(o,b),f(b,S),f(b,Y),f(b,T),c&&c.m(b,null),X||(l=[se(s=ye.call(null,e,r[8])),R(e,"mousedown",r[9]),R(e,"mouseup",r[10]),R(e,"mousemove",r[11]),R(e,"wheel",r[12],{passive:!0}),R(e,"contextmenu",Me)],X=!0)},p(_,[y]){s&&re(s.update)&&y&77&&s.update.call(null,_[8]),_[6]?i?i.p(_,y):(i=j(_),i.c(),i.m(o,w)):i&&(i.d(1),i=null),y&16&&W(Y,_[4]),_[5]!==null?c?c.p(_,y):(c=U(_),c.c(),c.m(b,null)):c&&(c.d(1),c=null)},i:V,o:V,d(_){_&&p(t),r[7](null),i&&i.d(),c&&c.d(),X=!1,ne(l)}}}const Me=r=>{r.preventDefault()};function ke(r,t,e){let s,n,a,h=!1,o=-1,u=0,d=null;const g=()=>{if(cancelAnimationFrame(o),o=requestAnimationFrame(g),h){e(3,h=!1),e(4,u++,u);const l=performance.now();a.render(),e(5,d=performance.now()-l)}};let w=null;ae(()=>{const l=parseInt(new URL(location.href).searchParams.get("seed")??"0");e(1,n=new ve(l));const i=n.closest0(0,0);n.reveal(i.x,i.y),e(2,a=new ue(n,s)),setTimeout(()=>{a.cameraTranslate(s.width/2,s.height/2),e(3,h=!0)},100),k.onLoad(()=>{e(3,h=!0)}),console.log(n),g()}),ie(()=>{try{location.reload()}catch{}});function E(l){oe[l?"unshift":"push"](()=>{s=l,e(0,s)})}return[s,n,a,h,u,d,w,E,(l,i)=>{e(0,s.width=l,s),e(0,s.height=i,s),a.cameraScale(1),e(6,w=null),e(3,h=!0)},l=>{if(document.pointerLockElement!=s){if(l.button==1)s.requestPointerLock(),l.preventDefault();else if(l.button==0){l.preventDefault();const i=a.cameraPos(l.offsetX,l.offsetY);n.reveal(i.x,i.y),e(3,h=!0)}else if(l.button==2){l.preventDefault();const i=a.cameraPos(l.offsetX,l.offsetY);n.flag(i.x,i.y),e(3,h=!0)}}},l=>{document.pointerLockElement==s&&l.button==1&&document.exitPointerLock()},l=>{e(6,w=a.cameraPos(l.offsetX,l.offsetY)),document.pointerLockElement==s&&(a.cameraTranslate(l.movementX,l.movementY),e(3,h=!0))},l=>{const i=l.deltaY>0?.9:1.1;a.cameraZoom!=a.cameraScale(i)&&(e(6,w=a.cameraPos(l.offsetX,l.offsetY)),e(3,h=!0))}]}class Ee extends le{constructor(t){super(),he(this,t,ke,xe,te,{})}}export{Ee as component};
